
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">

<html>
<head>
<script type="text/javascript">

  function resizeIframe(iframe) {
    var newheight;
    var newwidth;

    if(document.getElementById){
        newwidth=iframe.contentWindow.document.body.scrollWidth;
        newheight=iframe.contentWindow.document.body.scrollHeight;
    }

    iframe.height= (newheight) + "px";
    iframe.width= (newwidth) + "px";
  }
</script>
<title>Building a Docker Container Image</title>

<link href="/web.css" rel="stylesheet" type="text/css">
</head>
<body leftmargin="0" topmargin="0" marginwidth="0" marginheight="0">

<table width="100%" border="0" cellspacing="0" cellpadding="0">
<tr>
   <td width="1%" align="left" class="bgred" valign="top">
      <div align="center">
      &nbsp;<br>
      <a href="http://www.wisc.edu">

      <img src="/images/uw-sm-red.png" width="125" height="46" border="0"> </a>
       </div>

	<ul class="sidebar">
	<li><a href="/">CHTC Home</a></li>
	
	<li>About
		<ul>
		<li><a href="/approach.shtml">Our Approach</a></li>
<!--comment		<li><a href="/resources.shtml">Our Resources</a></li>   -->
		<li><a href="/projects.shtml">Our Customers</a></li>
		<li><a href="/people.shtml">Our Staff</a></li>
		<li><a href="/jobs.shtml">Our Open Positions</a></li>
		</ul>
	</li>
	
	<li>How To's
		<ul>
		<li><a href="/get-started.shtml">Get Started</a></li>
		<li><a href="/get-help.shtml">Get Help</a></li>
        	<li><a href="/guides.shtml">All User Guides</a></li>
                <li><a href="/use-submit-node.shtml">Use an HTC Submit Server</a></li>
		<li><a href="/helloworld.shtml">Run Your First HTC Jobs</a></li>
		<li><a href="/howto_overview.shtml">HTC for MatLab, Python or R</a></li>
		<li><a href="/HPCuseguide.shtml">Use the HPC Cluster</a></li>
		<li><a href="/cite-chtc.shtml">Cite CHTC Resources</a></li>
		</ul>
	</li>
	<li><a href="/user-news.shtml">User News</a></li>
	<li>Other Resources
		<ul>
		<!--<li><a href="http://monitor.chtc.wisc.edu/uw_condor_usage/usage1.shtml">Pool Usage Reports</a></li>-->
<!--comment		<li><a href="/opmetrics.shtml">Operational Metrics</a></li>  -->
		<li><a href="/gpu-lab.shtml">CHTC GPU Lab</a></li>
		<li><a href="http://research.cs.wisc.edu/htcondor/">HTCondor Project</a></li>
		<li><a href="http://www.neos-server.org/">NEOS Optimization Service</a></li>
		<li><a href="http://www.opensciencegrid.org/">Open Science Grid</a></li>
		<li><a href="http://wid.wisc.edu/">WID (Wisconsin Institute for Discovery)</a></li>
		</ul>
	</li>
	</ul>

	</td>

<td width="97%" valign="top"> 


	<TABLE SUMMARY="Navigation layout" BORDER="0" WIDTH="100%" CELLSPACING="0" CELLPADDING="0">
<TR ALIGN="left"> 
  <TD WIDTH="100%" height="400" Align="left" VALIGN="top"> 
    <A  name="body"></a> 
	<div id = "main">

<!-- Top of Page Body -->
<table BORDER="0" WIDTH="100%">
<!-- <h1 align=left valign=center>The Center for High Throughput Computing</h1> -->

	

<div id="osg_power"> <span style="height: 20px">Powered by:</span><br /><a href="http://opensciencegrid.org"><img alt="Open Science Grid" src="/images/Open_Science_Grid_Consortium(Logo).jpg" width="123" height="70" /></a></div>

	

<div id="hours"> <span style="height: 20px">
	<center><b>Follow us on social media:</b><a href="https://twitter.com/CHTC_UW"><img alt="Twitter" src="/images/twitter.png" width="70" height="70"></center></a></span></div>
	
	
<div id="hours"> <span style="height: 20px">
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<a href="http://chtc.cs.wisc.edu/get-help.shtml" style="color:white;">
<b>Office Hours!</b>
<br>
Tues/Thurs, 3-4:30pm<br>
Wed, 9:30-11:30am</br>
Click for details
</a></span></div>	


	


<div style="margin-top:1em;"><a href="http://chtc.cs.wisc.edu/"><img alt="Center for High Throughput Computing" src="/images/CHTC-logo.png" width="500" height="90"></a></div>

<h1>Building a Docker Container Image</h1>


<p>Linux containers are a way to build a self-contained environment that
includes software, libraries, and other tools. CHTC currently supports
running jobs inside <a href="https://www.docker.com/what-docker">Docker</a>
containers. This guide describes how to build a Docker container image
that you can use for running jobs in CHTC. For information on using 
this container image for jobs, see our <a href="docker-jobs.shtml">Docker Jobs guide</a>.</p>

<h1 id="overview">Overview</h1>

<p><strong>Note that all the steps below should be run on your own computer, not
in CHTC.</strong></p>

<p>Docker container images can be created using a special file format
called a “Dockerfile”. This file has keywords that allow you to:</p>

<ul>
  <li>use a pre-existing Docker container as a base</li>
  <li>add files into the container</li>
  <li>run installation commands</li>
  <li>set environment variables</li>
</ul>

<p>You can then “build” a container image from this
file, test it locally, and push it to a central Docker location where
HTCondor can then use it to run jobs. Different versions of the
container image can be labeled with different version “tags”. This guide
has:</p>

<ol>
  <li><a href="#a-step-by-step-instructions">Step by Step Instructions</a></li>
  <li><a href="#b-examples">Examples</a></li>
</ol>

<h1 id="a-step-by-step-instructions">A. Step by Step Instructions</h1>

<h2 id="1-set-up-docker-on-your-computer">1. Set Up Docker on Your Computer</h2>

<p>If you haven’t already, create a DockerHub account and install 
Docker on your computer. You’ll want to look for the <a href="https://store.docker.com/search?type=edition&amp;offering=community">Docker Community
Edition</a>
for your operating system. It sometimes takes some time for Docker to
start, especially the first time. Once Docker starts, it won’t open a 
window; you’ll just see a little whale and container icon in one of your 
computers toolbars. In order to actually use Docker, you’ll need to 
open a command line program (like Terminal, or Command Prompt) and run 
commands there.</p>

<h2 id="2-explore-docker-containers-optional">2. Explore Docker Containers (optional)</h2>

<p>If you have never used Docker before, we recommend exploring a pre-existing container 
and testing out installation steps interactively before creating a Dockerfile. See the 
first half of this guide: <a href="docker-test.shtml">Exploring and Testing a Docker Container</a></p>

<h2 id="3-create-a-dockerfile">3. Create a Dockerfile</h2>

<p>A Dockerfile is a plain text file with keywords that add elements to a 
Docker container. There are many keywords that can be used in a Dockerfile (documented on
the Docker website here: <a href="https://docs.docker.com/engine/reference/builder/">Dockerfile
keywords</a>), but we will use a 
subset of these keywords following this basic outline:</p>

<ul>
  <li>Starting point: Which Docker container do you want to start with?</li>
  <li>Additions: What needs to be added? Folders? Data? Other software?</li>
  <li>Environment: What variables (if any) are set as part of the software installation?</li>
</ul>

<h3 id="create-the-file">Create the file</h3>

<p>Create a blank text file. Because of 
the way Docker builds containers, you should create a separate folder for each 
new container you create with the appropriate Dockerfile inside. 
You can call the file whatever you want, but the
convention is to use the name <code>Dockerfile</code>, with no file extension.</p>

<h3 id="from-choose-a-base-container-image">FROM: Choose a “base” container image</h3>

<p>Often you don’t want to start building your container image from
scratch; you’ll want to choose a base container image to add things to.</p>

<p>You can find a base container image by searching DockerHub. If you’re
using a scripting language like Python, R or perl, you could start with
the official image from these languages. If you’re not sure what to
start with, using a basic Linux image (Debian, Ubuntu and CentOS are common 
examples) is often a good place to start.</p>

<p>Container images often have tagged versions. Besides choosing the image
you want, make sure to choose a version by clicking on the “Tags” tab of
the image.</p>

<p>Once you’ve decided on a base image and version, add it as the first
line of your Dockerfile, like this:</p>

<pre class="file"><code>FROM username/imagename:tag
</code></pre>

<h3 id="copy-and-run-copy-files-and-install-software">COPY and RUN: Copy files and install software</h3>

<p>The next step is the most challenging. We need to add commands to the
Dockerfile to install the software. There are a few standard ways to to
do this:</p>

<ul>
  <li>Use a Linux package manager - usually <code>apt-get</code> for Debian/Ubuntu-based 
containers or <code>yum</code> for RedHat Linux containers, including CentOS.</li>
  <li>Use a software-specific package manager (like <code>pip</code>, or <code>conda</code>)</li>
  <li>Use installation instructions (usually a progression of <code>configure</code>,
<code>make</code>, <code>make install</code>)</li>
</ul>

<p>Each of these options will be prefixed by the <code>RUN</code> keyword. You can
join together linked commands with the <code>&amp;&amp;</code> symbol; to break lines, put
a backslash <code>\</code> at the end of the line.</p>

<p>If you need to copy specific files (like source code) into the
container, you can do so by placing the files in the same folder as the
Dockerfile, and using the <code>COPY</code> keyword. You could also download files 
within the container by using the <code>RUN</code> keyword and commands like <code>wget</code> or <code>git clone</code>.</p>

<p>In the example below, we show most of these options. Note that the Python source code
(<code>Python-3.2.1.tgz</code>) has been downloaded to the directory with the
Dockerfile in advance.</p>

<pre class="file"><code>## Build the container based on Ubuntu Linux
FROM ubuntu/ubuntu:bionic

## Copy the Python source code from your computer 
## into the container
COPY Python-3.5.2.tgz /tmp

## Update the Ubuntu system tools
RUN apt-get update

## Use the standard instructions for 
## installing Python from source code
RUN cd /tmp
	&amp;&amp; tar -xzf Python-3.2.1.tgz \
	&amp;&amp; cd Python-3.2.1 \
	&amp;&amp; ./configure \
	&amp;&amp; make \
	&amp;&amp; make install

## Use the python package manager pip to 
## install the numpy package
RUN pip3 install numpy
</code></pre>

<h3 id="env-set-the-environment">ENV: Set the environment</h3>

<p>If you’re installing a program to a custom location (like a home
directory), you may need to add that directory to the container’s system
PATH.</p>

<pre class="file"><code>ENV PATH="/home/software/bin:${PATH}"
</code></pre>

<h2 id="4-build-and-name-the-container-image">4. Build and Name the Container Image</h2>

<p>So far we haven’t actually created the container – we’ve just been
listing instructions for the container in the Dockerfile. But we are now
ready to build the container image!</p>

<p>First, decide on a name for the container image, as well as a tag. Tags are
important for tracking which version of the image you’ve created (and
are using). A simple tag scheme would be to use numbers (e.g. v0, v1,
etc.), but you can use any system that makes sense to you. The image name 
will also include your Docker Hub user name.</p>

<p>To build and tag your image, open a Terminal (Mac/Linux) or Command
Prompt (Windows) and navigate to the folder that contains your
Dockerfile:</p>

<pre class="term"><code>$ cd directory
</code></pre>

<p>(Replace “directory” with the path to the appropriate folder.)</p>

<p>Then make sure Docker is running (there should be a small icon on either
your top or bottom status bar) and run:</p>

<pre class="term"><code>$ docker build -t username/imagename:tag -f dockerfile .
</code></pre>

<p>Replace <code>username</code> with your Docker Hub user name and replace
 <code>imagename</code> and <code>tag</code> with the values of your choice.</p>

<p>If you get errors, try to determine what you may need to add or change
to your Dockerfile and then run the build command again.</p>

<h2 id="5-test-locally">5. Test Locally</h2>

<p>This page describes how to interact with your new Docker image on your
own computer, before trying to run a job with it in CHTC:</p>

<ul>
  <li><a href="/docker-test.shtml">Exploring a Docker Container on Your Computer</a></li>
</ul>

<h2 id="6-push-to-dockerhub">6. Push to DockerHub</h2>

<p>Once your container image has been successfully built and tested, you
can push it to DockerHub so that it will be available to run jobs in
CHTC. To do this, run the following command:</p>

<pre class="term"><code>$ docker push username/imagename:tag
</code></pre>

<p>The first time you push an image to DockerHub, you may need to run this
command first:</p>

<pre class="term"><code>$ docker login
</code></pre>

<p>It should ask for your DockerHub username and password.</p>

<h2 id="7-running-jobs">7. Running Jobs</h2>

<p>Once your Docker container image is on Docker Hub, you can use it to run 
jobs on CHTC’s HTC system. See this guide for more details:</p>

<ul>
  <li><a href="/docker-jobs.shtml">Running Docker Jobs in CHTC</a></li>
</ul>

<h1 id="b-examples">B. Examples</h1>

<p>The following is a non-exhaustive list of sample Dockerfiles</p>

<h2 id="cutadapt">cutadapt</h2>

<p>Sample Dockerfile for installing
<a href="https://github.com/marcelm/cutadapt/">cutadapt</a> with Python 3.4.</p>

<pre><code>FROM python:3.4-wheezy
RUN pip3 install cutadapt
</code></pre>

<h2 id="jags--rjags">JAGS + rjags</h2>

<p>Sample Dockerfile for installing the <a href="http://mcmc-jags.sourceforge.net/">JAGS
program</a> and <a href="">rjags package for
R.</a>. It assumes that the <a href="https://sourceforge.net/projects/mcmc-jags/files/JAGS/4.x/Source/">JAGS
source</a>
has been downloaded into the directory with the Dockerfile.</p>

<pre><code>FROM rocker/r-ver:3.4.0

COPY JAGS-4.3.0.tar.gz /tmp
RUN cd /tmp \
    &amp;&amp; tar -xzf JAGS-4.3.0.tar.gz \
    &amp;&amp; cd JAGS-4.3.0 \
    &amp;&amp; ./configure \
    &amp;&amp; make \
    &amp;&amp; make install

RUN install2.r --error \ 
        rjags
</code></pre>

<h2 id="qiime">QIIME</h2>

<p>Sample Dockerfile for installing <a href="https://qiime2.org/">QIIME2</a> based on
<a href="https://docs.qiime2.org/2017.11/install/native/">these instructions</a>.
It assumes that the <a href="https://conda.io/miniconda.html">Linux 64-bit miniconda
installer</a> has been downloaded into the
directory with the Dockerfile.</p>

<pre><code>FROM python:3.6-stretch

COPY Miniconda3-latest-Linux-x86_64.sh /tmp

RUN mkdir /home/qiimeuser
ENV HOME /home/qiimeuser

RUN cd /tmp &amp;&amp; \
    ./Miniconda3-latest-Linux-x86_64.sh -b -p /home/qiimeuser/minconda3 &amp;&amp; \
    export PATH=/home/qiimeuser/minconda3/bin:$PATH &amp;&amp; \
    conda update conda &amp;&amp; \
    conda create -n qiime2-2017.10 \
    --file https://data.qiime2.org/distro/core/qiime2-2017.10-conda-linux-64.txt
</code></pre>



<div id = "copyright">
     <p align = "center"> 
	  
     For all user support, questions, and comments:
     <strong><a href="mailto:chtc@cs.wisc.edu">chtc@cs.wisc.edu</a></strong>

</p>
</div>

</div>

  </td>
  </tr>

</TABLE>
</td>
</table>

</body>
</html>


