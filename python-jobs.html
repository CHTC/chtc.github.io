
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">

<html>
<head>
<script type="text/javascript">

  function resizeIframe(iframe) {
    var newheight;
    var newwidth;

    if(document.getElementById){
        newwidth=iframe.contentWindow.document.body.scrollWidth;
        newheight=iframe.contentWindow.document.body.scrollHeight;
    }

    iframe.height= (newheight) + "px";
    iframe.width= (newwidth) + "px";
  }
</script>
<title>Running Python Jobs on CHTC</title>

<link href="/web.css" rel="stylesheet" type="text/css">
</head>
<body leftmargin="0" topmargin="0" marginwidth="0" marginheight="0">

<table width="100%" border="0" cellspacing="0" cellpadding="0">
<tr>
   <td width="1%" align="left" class="bgred" valign="top">
      <div align="center">
      &nbsp;<br>
      <a href="http://www.wisc.edu">

      <img src="/images/uw-sm-red.png" width="125" height="46" border="0"> </a>
       </div>

	<ul class="sidebar">
	<li><a href="/">CHTC Home</a></li>
	
	<li>About
		<ul>
		<li><a href="/approach.shtml">Our Approach</a></li>
<!--comment		<li><a href="/resources.shtml">Our Resources</a></li>   -->
		<li><a href="/projects.shtml">Our Customers</a></li>
		<li><a href="/people.shtml">Our Staff</a></li>
		<li><a href="/jobs.shtml">Our Open Positions</a></li>
		</ul>
	</li>
	
	<li>How To's
		<ul>
		<li><a href="/get-started.shtml">Get Started</a></li>
		<li><a href="/get-help.shtml">Get Help</a></li>
        	<li><a href="/guides.shtml">All User Guides</a></li>
                <li><a href="/use-submit-node.shtml">Use an HTC Submit Server</a></li>
		<li><a href="/helloworld.shtml">Run Your First HTC Jobs</a></li>
		<li><a href="/howto_overview.shtml">HTC for MatLab, Python or R</a></li>
		<li><a href="/HPCuseguide.shtml">Use the HPC Cluster</a></li>
		<li><a href="/cite-chtc.shtml">Cite CHTC Resources</a></li>
		</ul>
	</li>
	<li><a href="/user-news.shtml">User News</a></li>
	<li>Other Resources
		<ul>
		<!--<li><a href="http://monitor.chtc.wisc.edu/uw_condor_usage/usage1.shtml">Pool Usage Reports</a></li>-->
<!--comment		<li><a href="/opmetrics.shtml">Operational Metrics</a></li>  -->
		<li><a href="http://research.cs.wisc.edu/htcondor/">HTCondor Project</a></li>
		<li><a href="http://www.neos-server.org/">NEOS Optimization Service</a></li>
		<li><a href="http://www.opensciencegrid.org/">Open Science Grid</a></li>
		<li><a href="http://wid.wisc.edu/">WID (Wisconsin Institute for Discovery)</a></li>
		</ul>
	</li>
	</ul>

	</td>

<td width="97%" valign="top"> 


	<TABLE SUMMARY="Navigation layout" BORDER="0" WIDTH="100%" CELLSPACING="0" CELLPADDING="0">
<TR ALIGN="left"> 
  <TD WIDTH="100%" height="400" Align="left" VALIGN="top"> 
    <A  name="body"></a> 
	<div id = "main">

<!-- Top of Page Body -->
<table BORDER="0" WIDTH="100%">
<!-- <h1 align=left valign=center>The Center for High Throughput Computing</h1> -->

	

<div id="osg_power"> <span style="height: 20px">Powered by:</span><br /><a href="http://opensciencegrid.org"><img alt="Open Science Grid" src="/images/Open_Science_Grid_Consortium(Logo).jpg" width="123" height="70" /></a></div>

	

<div id="hours"> <span style="height: 20px">
	<center><b>Follow us on social media:</b><a href="https://twitter.com/CHTC_UW"><img alt="Twitter" src="/images/twitter.png" width="70" height="70"></center></a></span></div>
	
	
<div id="hours"> <span style="height: 20px">
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<a href="http://chtc.cs.wisc.edu/get-help.shtml" style="color:white;">
<b>Office Hours!</b>
<br>
Tues/Thurs, 3-4:30pm<br>
Wed, 9:30-11:30am</br>
Click for details
</a></span></div>	


	


<div style="margin-top:1em;"><a href="http://chtc.cs.wisc.edu/"><img alt="Center for High Throughput Computing" src="/images/CHTC-logo.png" width="500" height="90"></a></div>

<h1>Running Python Jobs on CHTC</h1>


<p><strong>To best understand the below information, users should already have an
understanding of:</strong></p>

<ul>
  <li>Using the command line to: navigate within directories,
create/copy/move/delete files and directories, and run their
intended programs (aka "executables").</li>
  <li><a href="http://chtc.cs.wisc.edu/helloworld.shtml">The CHTC's Intro to Running HTCondor
Jobs</a></li>
</ul>

<h1 id="overview">Overview</h1>

<p>CHTC provides several copies of Python that can be used to run Python
code in jobs. See our list of supported versions here: <a href="#supported">CHTC Supported
Python</a></p>

<p>This guide details the steps needed to:</p>

<ol>
  <li><a href="#build">Create a portable copy of your Python packages</a></li>
  <li><a href="#script">Write a script that uses Python and your packages</a></li>
  <li><a href="#submit">Submit jobs</a></li>
</ol>

<p>If you want to build your own copy of base Python, see this archived
page:</p>

<ul>
  <li><a href="archived/python-jobs.shtml">Building a Python installation</a></li>
</ul>

<p>[]{#supported}</p>

<h1 id="supported-python-installations">Supported Python Installations</h1>

<p>\</p>

<p>Python version   Name of Python installation file
  —————- ———————————-
  Python 3.6       python36.tar.gz
  Python 3.7       python37.tar.gz</p>

<p>[]{#build}</p>

<ol>
  <li>
    <h1 id="adding-python-packages">Adding Python Packages</h1>
  </li>
</ol>

<p>If your code uses specific Python packages (like <code>numpy</code>, <code>matplotlib</code>,
<code>sci-kit learn</code>, etc) follow the directions below to download and
prepare the packages you need for job submission. <strong>If your job does not
require any extra Python packages, skip to parts 2 and 3.</strong></p>

<p>You are going to start an interactive job that runs on the HTC build
servers and that downloads a copy of Python. You will then install your
packages to a folder and zip those files to return to the submit server.</p>

<blockquote>
  <p>These instructions are primarily about adding packages to a fresh
install of Python; if you want to add packages to a pre-existing
package folder, there will be notes below in boxes like this one.</p>
</blockquote>

<p>[]{#version}</p>

<h2 id="a-submit-an-interactive-job">A. Submit an Interactive Job</h2>

<p>Create the following special submit file on the submit server, calling
it something like <code>build.sub</code>.</p>

<pre><code class="language-{.sub}"># Python build file

universe = vanilla
log = interactive.log

# Choose a version of Python from the table above
transfer_input_files = http://proxy.chtc.wisc.edu/SQUID/chtc/python##.tar.gz

+IsBuildJob = true
requirements = (OpSysMajorVer =?= 7) &amp;&amp; ( IsBuildSlot == true )
request_cpus = 1
request_memory = 2GB
request_disk = 2GB

queue
</code></pre>

<p>The only thing you should need to change in the above file is the name
of the <code>python##.tar.gz</code> file - in the "transfer_input_files" line.
We have two versions of Python available to build from -- see the table
above.</p>

<blockquote>
  <p>If you want to add packages to a pre-existing package directory, add
the <code>tar.gz</code> file with the packages to the <code>transfer_input_files</code>
line:</p>

  <pre><code class="language-{.sub}">transfer_input_files = http://proxy.chtc.wisc.edu/SQUID/chtc/python##.tar.gz, packages.tar.gz
</code></pre>
</blockquote>

<p>Once this submit file is created, you will start the interactive job by
running the following command:</p>

<pre><code class="language-{.term}">[alice@submit]$ condor_submit -i build.sub
</code></pre>

<p>It may take a few minutes for the build job to start.</p>

<h2 id="b-install-the-packages">B. Install the Packages</h2>

<p>Once the interactive build job starts, you should see the Python that
you specified inside the working directory:</p>

<pre><code class="language-{.term}">[alice@build]$ ls -lh
-rw-r--r-- 1 alice alice  78M Mar 26 12:24 python##.tar.gz
drwx------ 2 alice alice 4.0K Mar 26 12:24 tmp
drwx------ 3 alice alice 4.0K Mar 26 12:24 var
</code></pre>

<p>We'll now unzip the copy of Python and set the <code>PATH</code> variable to
reference that version of Python:</p>

<pre><code class="language-{.term}">[alice@build]$ tar -xzf python##.tar.gz
[alice@build]$ export PATH=$PWD/python/bin:$PATH
</code></pre>

<p>To make sure that your setup worked, try running:</p>

<pre><code class="language-{.term}">[alice@build]$ python3 --version
</code></pre>

<p>You can also try running this command to make sure the copy of python
that is now active is the one you just installed:</p>

<pre><code class="language-{.term}">[alice@build]$ which python3
</code></pre>

<p>The command above should return a path that includes the prefix
<code>/var/lib/condor/</code>, indicating that it is installed in your job's
working directory.</p>

<p>If you're using Python 2, use <code>python2</code> instead of <code>python3</code> above (and
in what follows). The output should match the version number that you
want to be using!</p>

<blockquote>
  <p>If you brought along your own package directory, un-tar it here and
skip the directory creation step below.</p>
</blockquote>

<p>First, create, a directory to put your packages into:</p>

<pre><code class="language-{.term}">[alice@build]$ mkdir packages
</code></pre>

<p>You can choose what name to use for this directory -- if you have
different sets of packages that you use for different jobs, you could
use a more descriptive name than "packages"</p>

<p>To install the Python packages run the following command:</p>

<pre><code class="language-{.term}">[alice@build]$ python3 -m pip install --target=$PWD/packages package1 package2 etc.
</code></pre>

<p>Replace <em>package1</em> <em>package2</em> with the names of packages you want to
install. <code>pip</code> should download all dependent packages and install them.
Certain packages may take longer than others.</p>

<h2 id="c-finish-up">C. Finish Up</h2>

<p>Right now, if we exit the interactive job, nothing will be transferred
back because we haven't created any new <strong>files</strong> in the working
directory, just <strong>sub-directories</strong>. In order to transfer back our
installation, we will need to compress it into a tarball file - not only
will HTCondor then transfer back the file, it is generally easier to
transfer a single, compressed tarball file than an uncompressed set of
directories.</p>

<p>Run the following command to create your own tarball of your packages:</p>

<pre><code class="language-{.term}">[alice@build]$ tar -czf packages.tar.gz packages/
</code></pre>

<p>Again, you can use a different name for the <code>tar.gz</code> file, if you want.</p>

<p>We now have our packages bundled and ready for CHTC! You can now exit
the interactive job and the tar.gz file with your Python packages will
return to the submit server with you (this sometimes takes a few extra
seconds after exiting).</p>

<pre><code class="language-{.term}">[alice@build]$ exit 
</code></pre>

<p>[]{#script}</p>

<ol>
  <li>
    <h1 id="creating-a-script">Creating a Script</h1>
  </li>
</ol>

<p>In order to use CHTC's copy of Python and the packages you have
prepared in an HTCondor job, we will need to write a script that unpacks
both Python and the packages and then runs our Python code. We will use
this script as as the <code>executable</code> of our HTCondor submit file.</p>

<p>A sample script appears below. After the first line, the lines starting
with hash marks are comments . You should replace "my_script.py" with
the name of the script you would like to run, and modify the Python
version numbers to be the same as what you used above to install your
packages.</p>

<pre><code class="language-{.file}">#!/bin/bash

# untar your Python installation. Make sure you are using the right version!
tar -xzf python##.tar.gz
# (optional) if you have a set of packages (created in Part 1), untar them also
tar -xzf packages.tar.gz

# make sure the script will use your Python installation, 
# and the working directory as its home location
export PATH=$PWD/python/bin:$PATH
export PYTHONPATH=$PWD/packages

# run your script
python3 my_script.py
</code></pre>

<p>If you have additional commands you would like to be run within the job,
you can add them to this base script. Once your script does what you
would like, give it executable permissions by running:</p>

<pre><code class="language-{.term}">[alice@submit] chmod +x run_python.sh
</code></pre>

<blockquote>
  <h2 id="arguments-in-python">Arguments in Python</h2>

  <p>To pass arguments to an R script within a job, you'll need to use the
following syntax in your main executable script, in place of the
generic command above:</p>

  <pre><code class="language-{.file}">python3 my_script.py $1 $2
</code></pre>

  <p>Here, <code>$1</code> and <code>$2</code> are the first and second arguments passed to the
bash script from the submit file (see below), which are then sent on
to the Python script. For more (or fewer) arguments, simply add more
(or fewer) arguments and numbers.</p>

  <p>In addition, your Python script will need to be able to accept
arguments from the command line. There is an explanation of how to do
this in <a href="http://swcarpentry.github.io/python-novice-inflammation/10-cmdline/index.html">this Software Carpentry
lesson</a>.</p>
</blockquote>

<p>[]{#submit}</p>

<ol>
  <li>
    <h1 id="submitting-jobs">Submitting Jobs</h1>
  </li>
</ol>

<p>A sample submit file can be found in our <a href="/helloworld.shtml">hello
world</a> example page. You should make the following
changes in order to run Python jobs:</p>

<ul>
  <li>
    <p>Your <code>executable</code> should be the script that you wrote
<a href="#script">above</a>.</p>

    <pre><code class="language-{.sub}">executable = run_py.sh
    Modify the CPU/memory request lines.  Test a few jobs for disk space/memory usage in 
order to make sure your requests for a large batch are accurate!  
Disk space and memory usage can be found in the log file after the job completes. 
     Change transfer_input_files to include: 
    transfer_input_files = http://proxy.chtc.wisc.edu/SQUID/chtc/python##.tar.gz, packages.tar.gz, my_script.py
</code></pre>
  </li>
  <li>
    <p>If your script takes arguments (see the box from the previous
section), include those in the arguments line:</p>

    <pre><code class="language-{.sub}">arguments = value1 value2
</code></pre>
  </li>
</ul>

<p>[]{#squid}</p>

<blockquote>
  <h3 id="how-big-is-your-package-tarball">How big is your package tarball?</h3>

  <p>If your package tarball is larger than 100 MB, you should NOT transfer
the tarball using <code>transfer_input_files</code>. Instead, you should use
CHTC's web proxy, <code>squid</code>. In order to request space on <code>squid</code>,
email the research computing facilitators at <a href="mailto:chtc@cs.wisc.edu">chtc@cs.wisc.edu</a>.</p>
</blockquote>



<div id = "copyright">
     <p align = "center"> 
	  
     For all user support, questions, and comments:
     <strong><a href="mailto:chtc@cs.wisc.edu">chtc@cs.wisc.edu</a></strong>

</p>
</div>

</div>

  </td>
  </tr>

</TABLE>
</td>
</table>

</body>
</html>


